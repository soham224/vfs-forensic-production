services:
  mysql:
    image: mysql:5.7
    container_name: mysql_container
    ports:
      - "3306:3306"
    volumes:
      - mysql_database:/var/lib/mysql
      - ./mysql-init.sql:/docker-entrypoint-initdb.d/mysql-init.sql
    environment:
      MYSQL_PASSWORD: Rootmysql@123
      MYSQL_ROOT_PASSWORD: Rootmysql@123
      MYSQL_DATABASE: vfs_auto_serving
    restart: always

  vfs-auto-serving-api:
    image: vfs_auto_serving_api_build:1.0.0
    build: ./backend
    ports:
      - "9000:80"   # BACKEND OPEN ON LOCALHOST:8000
    volumes:
      - backend-application-logs:/logs
      - /home/dev1079/frames/vfs/videos:/home/dev1079/frames/vfs/videos
      - /home/dev1079/frames/vfs/suspect_images:/home/dev1079/frames/vfs/suspect_images
    environment:
      MYSQL_HOSTNAME: mysql
      MYSQL_USERNAME: root
      MYSQL_PASS: Rootmysql@123
      MYSQL_PORT: 3306
      MYSQL_DB_NAME: vfs_auto_serving
      PROJECT_ENV: development
      MYSQL_POOL_SIZE: 20    # <-- REQUIRED
      MYSQL_MAX_OVERFLOW: 30  
      MYSQL_POOL_TIMEOUT: 60
      MYSQL_POOL_PRE_PING: "True"
    depends_on:
      - mysql
    restart: always

  vfs-auto-serving-ui:
    image: vfs_auto_serving_ui_build:1.0.0
    build: ./frontend
    ports:
      - "8080:80"    # FRONTEND OPEN ON LOCALHOST:8080
    environment:
      REACT_APP_ENV: local
      REACT_APP_API_HOST: http://localhost:8000/api/v1
    restart: always

  nginx:
    image: nginx:latest
    ports:
      - "80:80"      # PUBLIC ROOT â†’ localhost
    volumes:
      - ./frontend/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - vfs-auto-serving-ui
      - vfs-auto-serving-api
    restart: always
    entrypoint: >
      sh -c "rm -f /etc/nginx/conf.d/default.conf &&
             exec /docker-entrypoint.sh nginx -g 'daemon off;'"

volumes:
  backend-application-logs:
  mysql_database:
