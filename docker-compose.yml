services:
  mysql:
    image: mysql:5.7
    container_name: mysql_container
    ports:
      - "3306:3306"
    volumes:
      - mysql_database:/var/lib/mysql
      - ./mysql-init.sql:/docker-entrypoint-initdb.d/mysql-init.sql
    environment:
      MYSQL_PASSWORD: Rootmysql@123
      MYSQL_ROOT_PASSWORD: Rootmysql@123
      MYSQL_DATABASE: vfs_auto_serving
    restart: always

  vfs-auto-serving-api:
    image: vfs_auto_serving_api_build:1.0.0
    build: ./backend
    ports:
      - "9000:80"   # BACKEND OPEN ON LOCALHOST:8000
    volumes:
      - backend-application-logs:/logs
      - /home/dev56/Soham/frames/vfs/videos:/home/dev56/Soham/frames/vfs/videos
      - /home/dev56/Soham/suspect_images:/home/dev56/Soham/suspect_images
    environment:
      MYSQL_HOSTNAME: mysql
      MYSQL_USERNAME: root
      MYSQL_PASS: Rootmysql@123
      MYSQL_PORT: 3306
      MYSQL_DB_NAME: vfs_auto_serving
      PROJECT_ENV: development

      ROI_API_ENDPOINT: development
      USER_ID_CV2: '[1]'

      MYSQL_POOL_SIZE: 20    # <-- REQUIRED
      MYSQL_MAX_OVERFLOW: 30  
      MYSQL_POOL_TIMEOUT: 60
      MYSQL_POOL_PRE_PING: "True"

      BASE_DIR: /home/dev56/Soham/suspect_images
      CHECK_RTSP_DATA: ./client_data/check_rtsp_data
      LICENSE_SECRET_KEY: secret_key
      TOTAL_CHAIRS_COUNT: '{"1":10, "2":10, "3":10}'

      LOCAL_VIDEOS_PATH: /home/dev56/Soham/frames/vfs/videos
      LOCAL_NGINX_PATH: /home/dev56/Soham/suspect_images
      LOCAL_IP_URL: http://192.168.11.87:7000/suspect_images
      SUSPECT_IMG_DIR: /home/dev56/Soham/suspect_images
    depends_on:
      - mysql
    restart: always

  vfs-auto-serving-ui:
    image: vfs_auto_serving_ui_build:1.0.0
    build: ./frontend
    ports:
      - "8080:80"    # FRONTEND OPEN ON LOCALHOST:8080
    environment:
      REACT_APP_ENV: ${FRONTEND_APP_ENVIRONMENT}
      REACT_APP_IP: ${AUTO_SERVING_API_IP}
      REACT_APP_API_HOST: ${AUTO_SERVING_API_HOST}
      
    restart: always

  nginx:
    image: nginx:latest
    ports:
      - "7000:80"      # PUBLIC ROOT â†’ localhost
    volumes:
      - ./frontend/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /home/dev56/Soham/frames/vfs/videos:/videos  # allow nginx to serve mp4
      - /home/dev56/Soham/suspect_images:/suspect_images
    depends_on:
      - vfs-auto-serving-ui
      - vfs-auto-serving-api
    restart: always
    entrypoint: >
      sh -c "rm -f /etc/nginx/conf.d/default.conf &&
             exec /docker-entrypoint.sh nginx -g 'daemon off;'"

volumes:
  backend-application-logs:
  mysql_database:
